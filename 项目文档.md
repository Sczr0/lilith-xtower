# Phigros 查询工具 - 完整项目文档

## 📖 目录

1. [项目简介](#项目简介)
2. [快速开始](#快速开始)
3. [API 接口文档](#api-接口文档)
4. [内容管理系统](#内容管理系统)
5. [维护模式指南](#维护模式指南)
6. [SVG 渲染功能](#svg-渲染功能)
7. [常见问题管理](#常见问题管理)
8. [更新日志](#更新日志)

---

## 项目简介

这是一个基于 Next.js 15 的 Phigros（节奏游戏）查询和可视化工具，提供以下核心功能：

- **Best N 成绩图片生成** - 支持自定义主题和数量
- **单曲成绩查询** - 详细的单曲成绩信息
- **RKS 排行列表** - 评分计算详情
- **新曲速递** - 游戏更新内容管理
- **多种登录方式** - 扫码、SessionToken、API 凭证

### 技术栈

- **前端**: Next.js 15 + React 19 + TypeScript
- **样式**: TailwindCSS v4 + next-themes
- **部署**: Vercel
- **内容管理**: CLI + Markdown

---

## 快速开始

### 安装和运行

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm run start

# 代码检查
npm run lint
```

### 项目结构

```
src/app/
├── components/          # React 组件
├── contexts/           # React 上下文
├── lib/               # 工具库和 API 客户端
├── content/           # 静态内容（公告、QA、歌曲更新）
├── config/            # 配置文件
└── api/               # API 路由
```

### 开发命令

```bash
# 内容管理 CLI 工具
npm run content

# 内容管理快捷命令
npm run content:announcement  # 公告管理
npm run content:song          # 歌曲更新管理
```

---

## API 接口文档

**Base URL**: `https://evernight.xtower.site`

### 用户认证模块

#### 1. 请求登录二维码

```http
GET /auth/qrcode
```

**响应示例**:
```json
{
  "qrCodeImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "qrId": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
}
```

#### 2. 查询二维码扫码状态

```http
GET /auth/qrcode/{qrId}/status
```

**响应示例**:
```json
{
  "status": "success",
  "sessionToken": "TDS-USER-SESSION-TOKEN-EXAMPLE"
}
```

#### 3. 获取云存档数据

```http
POST /get/cloud/saves
Content-Type: application/json
```

**请求体** (SessionToken 方式):
```json
{
  "token": "TDS-MANUAL-SESSION-TOKEN-EXAMPLE"
}
```

**请求体** (联合查分 API 方式):
```json
{
  "data_source": "external",
  "api_user_id": "1934128044",
  "api_token": "optional-api-token-if-any"
}
```

### 成绩图片生成模块

#### 1. 生成 Best N 成绩图片

```http
POST /image/bn/{n}?theme=white
```

- `n`: Best N 数值 (如 19)
- `theme`: 主题 (white 或默认 dark)

**响应**: PNG 图片二进制数据

#### 2. 生成单曲成绩查询图片

```http
POST /image/song?q=Spasmodic
```

**响应**: PNG 图片二进制数据

### 成绩数据查询模块

#### 获取 RKS 成绩列表

```http
POST /rks
Content-Type: application/json
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "song_name": "Cthugha",
        "difficulty": "IN",
        "difficulty_value": 15.8,
        "acc": 99.8765,
        "rks": 15.7890
      }
    ]
  }
}
```

### 服务统计模块

#### 获取服务使用统计

```http
GET /image/stats
```

**响应示例**:
```json
{
  "bn": {
    "count": 12345,
    "last_updated": "2025-10-01T09:26:34.677Z"
  },
  "leaderboard": {
    "count": 5432,
    "last_updated": "2025-10-01T08:55:10.123Z"
  },
  "song": {
    "count": 67890,
    "last_updated": "2025-10-01T09:25:59.888Z"
  }
}
```

---

## 内容管理系统

### 概述

使用 **CLI + Markdown** 的混合方案管理公告、新曲速递和常见问题，无需后台管理系统。

### 快速开始

#### 启动 CLI 工具

```bash
npm run content
```

提供以下功能：
- 📢 添加公告
- 🎵 添加新曲速递
- ❓ 添加常见问题
- 📋 查看所有内容
- ⚙️ 维护配置管理
- ✏️ 编辑内容提示

### 文件结构

```
src/app/content/
├── announcements/           # 公告目录
│   ├── 2025-10-04-welcome.md
│   └── ...
├── song-updates/           # 新曲速递目录
│   ├── 2025-10-01-update-4.8.0.md
│   └── ...
└── qa/                     # 常见问题目录
    ├── how-to-get-sessiontoken-1736060000000.md
    └── ...
```

### 添加公告

1. 运行 `npm run content`
2. 选择 "📢 添加公告"
3. 按提示填写：
   - 公告标题
   - 公告类型（info/warning/maintenance）
   - 优先级（high/medium/low）
   - 是否允许"不再提示"
   - 公告内容（支持 Markdown）

**公告文件格式**:
```markdown
---
id: announcement-2025-10-04-welcome
title: 欢迎使用新版系统
type: info
publishDate: 2025-10-04T10:00:00+08:00
enabled: true
dismissible: true
priority: high
---

# 欢迎使用新版系统 🎉

这里是公告正文，支持完整的 **Markdown** 语法。
```

### 添加新曲速递

1. 运行 `npm run content`
2. 选择 "🎵 添加新曲速递"
3. 按提示填写：
   - 版本号（如 4.8.0）
   - 更新日期
   - **只需输入定数**（如 15.8、14.5、16.3），等级会自动计算

**重要提示**: 添加新曲速递时，只需输入定数 (1.0-20.0)，等级会自动计算（向下取整）。

**新曲速递文件格式**:
```markdown
---
updateId: update-2025-10-01
updateDate: 2025-10-01T00:00:00+08:00
version: 4.8.0
enabled: true
---

# Phigros 4.8.0 新曲速递

## 新增曲目

### WINTER ～願いを込めて～

- **艺术家**: TOKOTOKO（西沢さんP）
- **定数**:
  - EZ: 5.0
  - HD: 10.2
  - IN: 14.5
  - AT: 15.8
- **备注**: 冬日限定曲目
```

### 添加常见问题

1. 运行 `npm run content`
2. 选择 "❓ 添加常见问题"
3. 按提示填写：
   - 问题标题
   - 分类（登录相关/使用指南/技术问题/安全隐私）
   - 优先级（数字越小越靠前）
   - 答案内容（支持 Markdown）

**常见问题文件格式**:
```markdown
---
id: qa-1736060000000
question: 如何获取 SessionToken？
category: login
priority: 1
enabled: true
createdAt: '2025-01-05T12:00:00.000Z'
---

Phigros 游戏内没有直接获取 SessionToken 的方式。

你可以通过以下方式获取：
1. 使用扫码登录
2. 使用联合查分 API
3. 登录后在调试页面查看
```

### CLI 工具使用技巧

#### 定数输入说明

**只需输入定数，等级自动计算！**

- **定数范围**: 1.0-20.0（支持小数）
- **等级计算**: 自动向下取整（如定数15.8 → 等级15）

**正确示例**:
| 输入定数 | 自动计算等级 | 说明 |
|---------|------------|------|
| 15.8 | 15 | 定数15.8，等级15 |
| 14.5 | 14 | 定数14.5，等级14 |
| 3.2 | 3 | 定数3.2，等级3 |

#### 键盘快捷键

- `↑` `↓` - 选择选项
- `Enter` - 确认
- `Ctrl+C` - 取消操作
- `Space` - 切换选项

### 内容展示

- **公告**: 登录后自动弹窗显示未读公告，支持"不再提示"
- **新曲速递**: Dashboard 标签页查看，最新更新标记为"最新"
- **常见问题**: 独立页面展示，按优先级排序

### 最佳实践

#### 文件命名规范
- **公告**: `YYYY-MM-DD-简短描述.md`
- **新曲速递**: `YYYY-MM-DD-update-版本号.md`
- **常见问题**: `问题标题-时间戳.md`

#### 启用/禁用内容
将 Front Matter 中的 `enabled` 设为 `false` 即可隐藏内容。

---

## 维护模式指南

### 功能概述

系统支持自动维护模式：
- ✅ 提前 N 天显示维护预告横幅
- ✅ 维护期间全屏覆盖，禁止所有操作
- ✅ 自动时间检测和状态切换
- ✅ 用户可关闭预告横幅
- ✅ 每分钟自动刷新状态

### 配置文件

位置：`src/app/config/maintenance.config.ts`

```typescript
export const maintenanceConfig: MaintenanceConfig = {
  // 启用维护模式检查
  enabled: false,  // 改为 true 启用

  // 维护开始时间（ISO 8601 格式）
  startTime: '2025-01-20T09:00:00',

  // 维护结束时间
  endTime: '2025-01-20T12:00:00',

  // 提前多少天显示预告横幅
  preNoticeDays: 3,

  // 维护期间显示的标题
  title: '系统维护通知',

  // 维护期间的消息（支持 HTML）
  message: `
    受 Phigros 更新影响，本服务正在进行例行维护。<br/>
    <strong>预计恢复时间：2025年1月20日 12:00（UTC+8）</strong>
  `,

  // 预告横幅消息（支持 HTML）
  bannerMessage: `
    <strong>维护通知：</strong>
    本服务将于 <strong>2025年1月20日 09:00</strong> 开始例行维护。
  `,
};
```

### CLI 管理

使用 `npm run content` 选择 "⚙️ 维护配置管理"：

#### 功能菜单
- 👁️ 查看当前配置 - 显示所有参数和当前状态
- ✏️ 编辑配置 - 交互式编辑所有配置项
- 🔄 快速测试 - 一键测试维护功能

#### 快速测试
- **测试维护覆盖层**：立即进入维护模式，持续10分钟
- **测试预告横幅**：5分钟后进入维护，立即显示横幅

### 维护状态时间线

```
现在 ──────────────▶ 时间轴

├─ 维护前 N 天：显示橙色预告横幅（可关闭）
│  └─ 用户可以正常使用所有功能
│
├─ 维护开始：显示全屏覆盖层
│  └─ 所有功能不可用
│  └─ 显示维护信息和预计恢复时间
│
└─ 维护结束：自动恢复正常
   └─ 页面重新可用
```

### 使用示例

#### 设置正式维护
```bash
npm run content
# 选择 "⚙️ 维护配置管理" → "✏️ 编辑配置"
# 填写：
启用维护模式检查? Y
维护开始时间: 2025-01-20T09:00:00
维护结束时间: 2025-01-20T12:00:00
提前多少天显示预告横幅? 3
```

#### 快速测试维护界面
```bash
npm run content
# 选择 "⚙️ 维护配置管理" → "🔄 快速测试"
# 选择 "测试维护覆盖层（立即进入维护）"
```

### 注意事项

1. **时间格式严格**：必须是 `YYYY-MM-DDTHH:mm:ss` 格式
2. **时区说明**：时间为本地时间，无需转换时区
3. **测试后记得禁用**：快速测试后要禁用维护模式
4. **配置立即生效**：保存后刷新页面即可看到效果

---

## SVG 渲染功能

### 功能概述

支持 Best N 图片的 SVG 格式获取，并实现了客户端渲染下载功能。

### 优势

1. **性能优化**
   - SVG 体积更小，传输更快
   - 后端无需 CPU 密集的栅格化操作
   - 渲染压力分散到客户端，支持高并发

2. **灵活性**
   - 用户可自选下载分辨率（1x/2x/3x/4x）
   - 支持多种格式（PNG/JPG/WebP）
   - SVG 无损缩放，适合任意尺寸显示

3. **用户体验**
   - 快速显示预览
   - 按需高质量下载
   - 进度反馈

### 技术实现

#### 核心 API

```typescript
// 获取 SVG 格式
ImageAPI.generateBestNSVG(
  n: number,
  credential: AuthCredential,
  theme: BestNTheme
): Promise<string>

// 下载方法
SVGRenderer.downloadImage(
  svgText: string,
  filename: string,
  options?: {
    format?: 'png' | 'jpg' | 'webp',
    quality?: number,  // 0-1，默认 0.95
    scale?: number,    // 分辨率倍数，默认 2
    backgroundColor?: string
  },
  onProgress?: (progress) => void
): Promise<void>
```

#### 用户操作流程

1. 在 Dashboard 页面选择 Best N 图片生成
2. 选择格式为 "SVG (推荐)"
3. 点击"生成图片"
4. 快速显示 SVG 预览
5. 根据需要选择下载格式和分辨率
6. 点击"下载图片"并等待渲染进度
7. 自动下载到本地

### 注意事项

1. **字体渲染**：SVG 未内嵌字体，渲染器会尝试加载系统字体
2. **性能考虑**：分辨率 4x 会显著增加渲染时间和文件大小
3. **浏览器兼容性**：需要现代浏览器（支持 Canvas API）

---

## 常见问题管理

### 概述

支持通过命令行工具快速管理常见问题，内容存储在 `src/app/content/qa/` 目录。

### 功能特性

- ❓ **添加常见问题** - 交互式添加新的常见问题
- 📋 **查看所有常见问题** - 查看现有的所有 QA
- 🗑️ **删除常见问题** - 删除指定的 QA

### 分类系统

- 🔐 **登录相关** (login) - 认证、登录问题
- 📖 **使用指南** (usage) - 功能使用说明
- 🔧 **技术问题** (technical) - 技术相关问题
- 🔒 **安全隐私** (security) - 隐私和安全问题

### 文件格式

```markdown
---
id: qa-1736060000000
question: 如何获取 SessionToken？
category: login
priority: 1
enabled: true
createdAt: '2025-01-05T12:00:00.000Z'
---

这里是答案内容，支持 Markdown 格式。

- 可以使用列表
- 可以使用 **粗体**
- 可以使用 `代码`
```

### 数据流程

1. QA Markdown 文件存储在 `src/app/content/qa/`
2. `src/app/lib/qa.ts` 读取并解析所有 QA 文件
3. API 路由 `/api/qa` 提供 QA 数据
4. 前端页面通过 fetch 获取数据并渲染
5. 使用 ReactMarkdown 组件渲染答案内容

### 最佳实践

1. **优先级**：数字越小的问题会显示在越前面
2. **分类**：确保使用正确的分类值
3. **启用状态**：只有 `enabled: true` 的问题会在前端显示
4. **实时更新**：修改或添加 QA 后，刷新页面即可看到更新

---

## 更新日志

### [未发布]

#### 改进
- ✨ **重大改进**: 简化CLI工具和展示格式
  - **CLI**: 只需输入定数，等级自动计算（向下取整）
  - **展示**: 新曲速递只显示定数，不单独显示等级
  - 避免用户重复输入等级和定数
  - 扩大定数范围至 1.0-20.0
  - 更新所有相关文档和示例

#### 修复
- 🐛 修复CLI工具中定数输入问题，现在支持小数输入（如 15.8、14.5）
  - 将定数输入类型从 `number` 改为 `text`，使用 `parseFloat` 验证
  - 添加详细的输入验证和错误提示
  - 格式化输出时保留1位小数

#### 新增
- ✨ 完整的内容管理系统（公告 + 新曲速递）
- 🛠️ 交互式CLI工具 `npm run content`
- 📝 Markdown + YAML Front Matter 配置文件系统
- 🎨 公告弹窗组件（支持"不再提示"功能）
- 🎵 新曲速递展示组件（卡片式设计）
- 📖 完整的使用文档
- 🧪 自动化测试脚本验证定数输入逻辑

### [2025-10-04] - 初始版本

#### 新增
- 初始化项目结构
- 基础认证系统
- Dashboard界面

---

## 📞 技术支持

遇到问题请：
1. 查看本文档
2. 检查浏览器控制台错误
3. 查看项目 README
4. 提交 Issue 到 GitHub

**维护者**: Phigros Query Team
**最后更新**: 2025-10-06